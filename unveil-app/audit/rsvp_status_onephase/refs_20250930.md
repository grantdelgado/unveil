# RSVP Status References Audit â€” One-Phase Removal Assessment

**ğŸ“… Date**: September 30, 2025  
**ğŸ¯ Goal**: Identify all `rsvp_status` references to assess safe removal  
**ğŸ“Š Status**: âŒ **BLOCKING REFERENCES FOUND** - Cannot proceed with one-phase removal  

---

## ğŸš¨ **CRITICAL FINDINGS**

### âŒ **Database RPC Functions Still Use rsvp_status**

**`resolve_message_recipients()` RPC Function**:
```sql
-- Line in function definition:
AND (target_rsvp_statuses IS NULL OR eg.rsvp_status = ANY(target_rsvp_statuses))
```

This function is actively used by the messaging system and **WILL BREAK** if `rsvp_status` column is removed.

---

## ğŸ“Š **Complete Reference Audit**

### ğŸ”´ **BLOCKING References (Must Fix Before Removal)**

1. **Database RPC Function**: `resolve_message_recipients()`
   - **File**: Database function definition
   - **Usage**: `eg.rsvp_status = ANY(target_rsvp_statuses)`
   - **Impact**: Messaging audience selection will break
   - **Fix Required**: Update function to use `declined_at` logic

### ğŸŸ¡ **UI/Logic References (Need Updates)**

2. **StatusChip Component**: `components/features/host-dashboard/StatusChip.tsx`
   - **Lines**: 62, 71
   - **Usage**: `rsvp_status?: string | null` and `guest.rsvp_status === 'attending'`
   - **Impact**: Host dashboard guest status display

3. **Guest Event Home**: `app/guest/events/[eventId]/home/page.tsx`
   - **Line**: 127
   - **Usage**: `(guestInfo as { rsvp_status?: string })?.rsvp_status === 'attending'`
   - **Impact**: Guest CTA resolution logic

4. **Recipient Preview Hook**: `hooks/messaging/useRecipientPreview.ts`
   - **Lines**: 10, 54
   - **Usage**: `RSVP_STATUSES` import and `rsvp_status: recipient.declined_at ? 'declined' : 'attending'`
   - **Impact**: Message recipient preview

5. **Guest List Item**: `components/features/host-dashboard/GuestListItem.tsx`
   - **Line**: 114
   - **Usage**: `rsvp_status: guest.rsvp_status`
   - **Impact**: Host guest management

### ğŸŸ¢ **Type Definitions (Safe to Update)**

6. **Host Dashboard Types**: `components/features/host-dashboard/types.ts`
   - **Line**: 26
   - **Usage**: `rsvp_status: string | null;`

7. **Supabase Types**: `types/supabase.ts`
   - **Lines**: 41, 69, 97, 789, 913
   - **Usage**: Type definitions for `rsvp_status`

### ğŸ”µ **Constants/Enums (Can Remove)**

8. **Constants**: `lib/constants.ts`
   - **Lines**: 30-35
   - **Usage**: `RSVP_STATUS` enum definition

9. **Messaging Types**: `lib/types/messaging.ts`
   - **Lines**: 212-219
   - **Usage**: `RSVP_STATUSES` constants and `RsvpStatus` type

### ğŸŸ¢ **Test Files (Safe to Update)**

10. **Status Chip Tests**: `__tests__/features/host/status-chip.test.ts`
    - **Multiple lines**: Test data using `rsvp_status`

11. **Test Support**: `app/test-support/api/create-session/route.ts`
    - **Line**: 87
    - **Usage**: Test data with `rsvp_status: 'attending'`

### ğŸ”µ **Documentation (Safe to Update)**

12. **Audit Documentation**: `audit/rsvp_semantics_20250930/`
    - **Usage**: References to legacy field

13. **Guest Management Docs**: `docs/guest-management/guest-management-audit.md`
    - **Usage**: Documentation of RSVP status patterns

---

## ğŸš« **Why One-Phase Removal is NOT Safe**

### 1. **Active Database Function Usage**
The `resolve_message_recipients()` RPC function actively uses `rsvp_status` for audience filtering. Removing the column would cause:
- Messaging system failures
- Audience selection errors
- Potential data loss in message delivery

### 2. **UI Logic Dependencies**
Multiple UI components still read `rsvp_status` for display logic, causing:
- Broken guest status displays
- Incorrect CTA resolution
- Host dashboard errors

---

## âœ… **Required Two-Phase Approach**

### **Phase 1: Update Code to Use declined_at**
1. Update `resolve_message_recipients()` RPC to use `declined_at` instead of `rsvp_status`
2. Update all UI components to use `declined_at` logic
3. Update types and constants
4. Update tests
5. Deploy and verify

### **Phase 2: Remove Column (After Phase 1 Deployed)**
1. Verify no active usage of `rsvp_status`
2. Run atomic migration to drop column
3. Add compat view for analysts
4. Add CI guard

---

## ğŸ¯ **Next Steps**

**âŒ CANNOT PROCEED** with one-phase removal as requested.

**âœ… RECOMMEND** implementing Phase 1 updates first:
1. Fix `resolve_message_recipients()` RPC function
2. Update UI components to use `declined_at`
3. Deploy and verify
4. Then proceed with column removal in separate PR

This ensures zero downtime and no data loss during the transition.
